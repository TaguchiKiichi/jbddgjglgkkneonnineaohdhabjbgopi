let checkedUrl=new Set,waitUrl=new Set;const DIV_ID=chrome.runtime.id+(new Date).getTime().toString(16)+Math.floor(1e3*Math.random()).toString(16),RETRY_DELAY_TIME=3e3,EXTENSION_RELOAD_TIME=6e4,RETRY_LIMIT_COUNT=3;let isClearOverlay=!1,isReloaded=!1,suppressBeforeUnloadFlag=!1;function checkRuntimeLastError(){chrome.runtime.lastError}function init(){document.getElementsByTagName("html")[0].style.opacity=0,document.onkeydown=function(e){return!("i"===e.key&&e.ctrlKey&&e.shiftKey||"F12"===e.key)},document.oncontextmenu=function(){return!1}}window.addEventListener("beforeunload",(e=>{suppressBeforeUnloadFlag&&(e.stopImmediatePropagation(),suppressBeforeUnloadFlag=!1)}));const connectCheckUrl=()=>{chrome.runtime.connect({name:"checkUrl"}).onDisconnect.addListener((()=>{checkRuntimeLastError(),checkedUrl.has(window.location.href)||connectCheckUrl()}))},backForwardCacheUrl=()=>{chrome.runtime.connect({name:"backForwardCacheUrl"}).onDisconnect.addListener((()=>{checkRuntimeLastError(),checkedUrl.has(window.location.href)||backForwardCacheUrl()}))},setRetryCheckUrl=()=>{let e=3;const n=()=>{setTimeout((()=>{isClearOverlay||--e>=0&&(connectCheckUrl(),n())}),3e3)};n()},setExtensionsReload=()=>{setTimeout((()=>{isClearOverlay||sendExtensionsReloadMessage()}),6e4)};init(),connectCheckUrl(),setRetryCheckUrl(),setExtensionsReload(),document.onreadystatechange=()=>{"interactive"===document.readyState&&(document.body.prepend(overlayDiv()),document.getElementsByTagName("html")[0].style.opacity=1)},window.addEventListener("pageshow",(e=>{e.persisted&&(init(),backForwardCacheUrl())}));const sendExtensionsReloadMessage=()=>{isReloaded||(isReloaded=!0,chrome.runtime.connect({name:"reload"}).onDisconnect.addListener((()=>{checkRuntimeLastError()})))},sendRecheckUrlMessage=e=>{const n=chrome.runtime.connect({name:"recheckUrl"});n.onDisconnect.addListener((()=>{checkRuntimeLastError(),checkedUrl.has(e)||sendRecheckUrlMessage(e)})),n.postMessage({recheckUrl:e})},sendBeforeUnloadSuppressedMessage=e=>{const n=chrome.runtime.connect({name:"suppressBeforeUnload"});n.onDisconnect.addListener((()=>{checkRuntimeLastError(),sendBeforeUnloadSuppressedMessage(e)})),n.postMessage({suppressBeforeUnload:e})};chrome.runtime.onConnect.addListener((e=>{e.onMessage.addListener(handleMessage)}));const handleMessage=e=>{if(e.isActiveTabCheck){const e=window.location.href;return checkedUrl.delete(e),void sendRecheckUrlMessage(e)}if(e.suppressBeforeUnload)return suppressBeforeUnloadFlag=!0,void sendBeforeUnloadSuppressedMessage(e.suppressBeforeUnload);if(e.recheckUrl)checkedUrl.has(e.recheckUrl)||(init(),sendRecheckUrlMessage(e.recheckUrl));else if(e.fragmentUpdatedUrl)checkedUrl.has(e.fragmentUpdatedUrl)||sendRecheckUrlMessage(e.fragmentUpdatedUrl);else if(e.waitUrl)waitUrl.add(e.waitUrl);else if(e.passUrl&&(waitUrl.delete(e.passUrl),navigator.onLine&&checkedUrl.add(e.passUrl)),e.clearOverlay){if(0!==waitUrl.size)return;clearOverlay()}},clearOverlay=()=>{"complete"===document.readyState?(removeOverlay(),isClearOverlay=!0):document.onreadystatechange=()=>{removeOverlay(),isClearOverlay=!0}},removeOverlay=()=>{const e=document.getElementById(DIV_ID);e&&e.remove(),document.oncontextmenu=function(){return!0},document.onkeydown=function(){return!0},document.getElementsByTagName("html")[0].style.opacity=1},overlayDiv=()=>{let e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.background="#FFF",e.style.position="fixed",e.style.zIndex=2147483647,e.style.left=0,e.style.top=0,e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.visibility="visible",e.id=DIV_ID;let n=document.createElement("p");return n.innerText="設定読込中",n.fontSize="1.5rem",n.style.color="#999",e.appendChild(n),e};window.addEventListener("online",(()=>{checkedUrl.has(window.location.href)||(init(),connectCheckUrl())}));